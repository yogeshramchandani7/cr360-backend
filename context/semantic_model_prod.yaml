# =============================================================================
# CR360 CREDIT RISK SEMANTIC MODEL - PRODUCTION VERSION
# =============================================================================
# Version: 4.0
# Last Updated: January 2026
# Description: Comprehensive semantic model with query routing, domain knowledge,
#              taxonomy, relationships, and business context
# Token Estimate: ~32,000 tokens (well under Gemini 1M limit)
# Lines: ~1,550 (under 2,000 target)
# =============================================================================

model:
  name: cr360_credit_risk_analytics
  version: "4.0"
  database: postgresql  # Supabase
  schema: public
  default_currency: USD
  reporting_entity: "TD Bank US Retail"
  data_granularity: "Account-level with pre-computed aggregates"

# =============================================================================
# SECTION 1: QUERY ROUTING LOGIC (CRITICAL FOR TWO-TIER ARCHITECTURE)
# =============================================================================
# This section guides the LLM to choose the correct table based on query type
# WHY: Complex credit risk metrics require validated formulas (computed_metrics)
#      while breakdowns need granular data (accounts)

query_routing:
  description: |
    Two-tier query routing system:
    - accounts table: 1,141 rows of account-level data (granular)
    - computed_metrics table: 8 rows of pre-aggregated portfolio metrics (validated formulas)

  use_computed_metrics_when:
    - condition: "Portfolio-level aggregates without grouping"
      examples:
        - "What is the total outstanding balance?"
        - "What is the portfolio delinquency rate?"
        - "What is the overall NCO rate?"
      rationale: "Pre-computed, validated formulas - no calculation risk"

    - condition: "Complex ratios with annualization"
      examples:
        - "What is the net charge-off rate?"
        - "What is the ECL coverage ratio?"
        - "What is the return on equity?"
      rationale: "Annualization and complex formulas are error-prone for LLMs"

    - condition: "Query asks for 'total', 'overall', 'aggregate', or 'portfolio-level'"
      examples:
        - "Total exposure across all products"
        - "Overall average credit score"
      rationale: "No breakdown needed - use pre-computed totals"

  use_accounts_when:
    - condition: "Breakdowns with GROUP BY"
      examples:
        - "Show delinquency rate BY PRODUCT"
        - "Compare exposure BY REGION"
        - "Analyze by customer segment"
      rationale: "Requires grouping granular data"

    - condition: "Account-level filters"
      examples:
        - "Show Auto loans with credit score below 650"
        - "List accounts 90+ days past due"
        - "Find customers in the Southeast with high utilization"
      rationale: "Filtering requires row-level data"

    - condition: "Drill-downs and detailed views"
      examples:
        - "Show individual account details"
        - "List top 10 accounts by balance"
      rationale: "Account-level granularity needed"

    - condition: "Time series across multiple periods"
      examples:
        - "Show monthly balance trends"
        - "Track delinquency rate over 8 quarters"
      rationale: "Multiple as_of_date values in one query"

  critical_rule: |
    NEVER calculate NCO rate, ECL coverage, or other complex ratios from accounts table.
    ALWAYS use computed_metrics for metrics with annualization or complex denominators.

# =============================================================================
# SECTION 2: METRIC TAXONOMY (CONDENSED)
# =============================================================================
# Hierarchical classification of credit risk metrics - helps LLM understand
# metric families, relationships, and appropriate clarification questions

taxonomy:

  exposure:
    description: "Credit exposure and balance sheet positions"
    subcategories:
      gross_exposure: ["gross_credit_exposure", "total_committed_exposure", "exposure_at_default"]
      outstanding_balance: ["adjusted_eop_balance", "eop_balance", "drawn_amount"]
      credit_limits: ["current_credit_limit", "original_credit_limit", "available_credit"]
      commitments: ["undrawn_commitment", "contingent_exposure"]
    key_relationships:
      - "Gross Exposure = Outstanding + Undrawn Commitments"
      - "Outstanding is the base for delinquency calculations"
      - "Utilization = Outstanding / Credit Limit"

  delinquency:
    description: "Payment behavior and past-due status - early warning indicators"
    subcategories:
      delinquency_flags: ["delinquent_flag", "dpd_30_flag", "dpd_60_flag", "dpd_90_flag"]
      delinquency_amounts: ["delinquent_balance", "dpd_30_balance", "dpd_60_balance", "dpd_90_balance"]
      delinquency_rates: ["delinquency_rate_30", "delinquency_rate_60", "delinquency_rate_90"]
      delinquency_flow: ["roll_rate_current_to_30", "roll_rate_30_to_60", "cure_rate"]
    key_relationships:
      - "DPD 90+ ⊂ DPD 60+ ⊂ DPD 30+ (nested sets)"
      - "Delinquency Rate = Delinquent Balance / Total Outstanding"
      - "Roll rates predict future charge-offs"

  loss:
    description: "Actual and expected credit losses - direct P&L impact"
    subcategories:
      charge_offs: ["gross_charge_off", "net_charge_off", "net_charge_off_rate"]
      recoveries: ["recovery_amount", "recovery_rate"]
      provisions: ["allowance_balance", "provision_expense", "ecl_balance"]
      expected_loss: ["expected_credit_loss", "lifetime_ecl", "twelve_month_ecl"]
    key_relationships:
      - "Net Charge-off = Gross Charge-off - Recoveries"
      - "NCO Rate = Net Charge-off / Average Outstanding (annualized)"
      - "ECL = PD × LGD × EAD"
      - "Provision = Change in ECL"

  risk_scores:
    description: "Credit scores and default probabilities"
    subcategories:
      bureau_scores: ["current_credit_score", "origination_credit_score"]
      internal_scores: ["behavioral_score", "application_score"]
      probability_of_default: ["twelve_month_pd", "lifetime_pd"]
    key_relationships:
      - "Higher Score = Lower PD (inverse relationship)"
      - "PD is key input to ECL calculation"
      - "Score changes indicate credit migration"

  collateral:
    description: "Loan security and collateral adequacy"
    subcategories:
      ltv_metrics: ["current_ltv", "origination_ltv", "combined_ltv"]
      collateral_values: ["collateral_value", "mitigant_value", "appraised_value"]
    key_relationships:
      - "LTV = Loan Balance / Property Value"
      - "Higher LTV = Higher LGD"
      - "LTV > 100% = Underwater/Negative Equity"

  origination:
    description: "New loan production and underwriting quality"
    subcategories:
      volume_metrics: ["origination_volume", "origination_count", "funded_volume"]
      quality_metrics: ["approval_rate", "funding_rate", "average_origination_score"]
    key_relationships:
      - "Origination quality determines future performance"
      - "Vintage analysis tracks cohorts over time"

  behavioral:
    description: "Borrower behavior patterns - early warning signals"
    subcategories:
      utilization: ["utilization_rate", "available_credit", "overlimit_flag"]
      payment_behavior: ["minimum_payment_ratio", "full_payment_flag"]
    key_relationships:
      - "Utilization = Outstanding / Credit Limit"
      - "High Utilization (>80%) indicates financial stress"
      - "Rising utilization predicts future delinquency"

# =============================================================================
# SECTION 3: DATABASE TABLES
# =============================================================================

tables:

  # ---------------------------------------------------------------------------
  # ACCOUNTS TABLE - Account-Level Granular Data
  # ---------------------------------------------------------------------------
  accounts:
    description: "Account-level granular data - USE FOR BREAKDOWNS AND FILTERS"
    row_count: 1141
    granularity: "One row per account per quarter (8 quarters of data)"
    primary_key: [account_id, as_of_date]
    use_cases:
      - "Breakdowns by product, region, segment, vintage"
      - "Account-level filtering (credit score, DPD, status)"
      - "Customer-level queries"
      - "Drill-downs and detailed analysis"

    columns:
      # Identifiers
      account_id:
        type: VARCHAR(50)
        description: "Unique account identifier"
        example: "ACC-001"

      customer_id:
        type: VARCHAR(50)
        description: "Customer identifier (multiple accounts per customer possible)"
        example: "CUST-001"

      customer_name:
        type: VARCHAR(100)
        description: "Customer name"
        example: "John Smith"

      # Classifications (denormalized - no FK to dimension tables)
      product_code:
        type: VARCHAR(10)
        description: "Product type code"
        values: [MTG, AUTO, CC, PL, HELOC]
        value_meanings:
          MTG: "Mortgage"
          AUTO: "Auto Loan"
          CC: "Credit Card"
          PL: "Personal Loan"
          HELOC: "Home Equity Line of Credit"

      region_code:
        type: VARCHAR(20)
        description: "Geographic region"
        values: [Northeast, Southeast, Midwest, West, Central]

      customer_segment:
        type: VARCHAR(20)
        description: "Credit risk segment"
        values: [PRIME, NEAR_PRIME, SUBPRIME]

      application_channel:
        type: VARCHAR(30)
        description: "Origination channel"
        values: [BRANCH, ONLINE, MOBILE, BROKER, DEALER, DIRECT_MAIL]

      # Temporal
      as_of_date:
        type: DATE
        description: "Reporting date (quarterly snapshots)"
        note: "Part of composite primary key with account_id"

      origination_date:
        type: DATE
        description: "Date account was opened"

      funded_date:
        type: DATE
        description: "Date funds were disbursed"

      vintage_year:
        type: INTEGER
        description: "Year account was originated"
        example: 2024

      age_on_book_months:
        type: INTEGER
        description: "Months since origination"

      last_payment_date:
        type: DATE
        description: "Date of most recent payment"

      # Financial Balances
      adjusted_eop_balance:
        type: DECIMAL(18,2)
        description: "Outstanding balance at end of period"
        note: "PRIMARY METRIC for exposure calculations"
        formula: "EOP Balance + Accrued Interest + Deferred Fees - Unamortized Discount"

      current_credit_limit:
        type: DECIMAL(18,2)
        description: "Current authorized credit limit"
        note: "Used for utilization calculations"

      funded_amount:
        type: DECIMAL(18,2)
        description: "Original funded amount"

      exposure_at_default:
        type: DECIMAL(18,2)
        description: "Exposure if account defaults (for Basel ECL)"

      current_property_value:
        type: DECIMAL(18,2)
        description: "Current property value (for secured loans)"

      annual_income:
        type: DECIMAL(18,2)
        description: "Customer annual income"

      last_payment_amount:
        type: DECIMAL(18,2)
        description: "Amount of last payment"

      # Delinquency & Status
      days_past_due:
        type: INTEGER
        description: "Days past due (0 = current, 1-29 = early delinquency, 30+ = delinquent)"
        note: "Critical for delinquency rate calculations"

      account_status:
        type: VARCHAR(20)
        description: "Account status"
        values: [ACTIVE, CLOSED, PAID_OFF, CHARGED_OFF]

      impaired_flag:
        type: VARCHAR(1)
        description: "Y if account is impaired (non-performing)"
        values: [Y, N]

      ecl_stage:
        type: INTEGER
        description: "IFRS 9 ECL stage"
        values: [1, 2, 3]
        value_meanings:
          1: "Stage 1: Performing (12-month ECL)"
          2: "Stage 2: Underperforming (lifetime ECL)"
          3: "Stage 3: Credit-impaired (lifetime ECL)"

      ever_30_dpd_flag:
        type: VARCHAR(1)
        description: "Y if account has ever been 30+ DPD"
        values: [Y, N]

      max_dpd_12m:
        type: INTEGER
        description: "Maximum DPD in last 12 months"

      # Credit Scores & Risk
      current_credit_score:
        type: DECIMAL(10,2)
        description: "Current credit score (FICO or equivalent)"
        range: "300-850"

      origination_credit_score:
        type: DECIMAL(10,2)
        description: "Credit score at origination"

      twelve_month_pd:
        type: DECIMAL(10,6)
        description: "12-month probability of default (0-1)"

      loss_given_default:
        type: DECIMAL(10,4)
        description: "Loss given default (0-1)"

      expected_credit_loss:
        type: DECIMAL(18,2)
        description: "Expected credit loss amount (PD × LGD × EAD)"

      # Loan Characteristics
      current_ltv:
        type: DECIMAL(10,4)
        description: "Current loan-to-value ratio"

      origination_ltv:
        type: DECIMAL(10,4)
        description: "LTV at origination"

      debt_to_income:
        type: DECIMAL(10,4)
        description: "Debt-to-income ratio"

      utilization_rate:
        type: DECIMAL(10,4)
        description: "Credit utilization (for revolving accounts)"

      current_interest_rate:
        type: DECIMAL(10,4)
        description: "Current annual interest rate"

      rate_type:
        type: VARCHAR(20)
        description: "Interest rate type"
        values: [FIXED, VARIABLE]

      original_term_months:
        type: INTEGER
        description: "Original loan term in months"

      remaining_term_months:
        type: INTEGER
        description: "Remaining term in months"

      # Loss Metrics
      gross_charge_off_amount:
        type: DECIMAL(18,2)
        description: "Gross amount charged off"

      recovery_amount_ytd:
        type: DECIMAL(18,2)
        description: "Amount recovered YTD after charge-off"

      net_charge_off_ytd:
        type: DECIMAL(18,2)
        description: "Net charge-off (gross - recoveries)"

  # ---------------------------------------------------------------------------
  # COMPUTED_METRICS TABLE - Pre-Aggregated Portfolio Metrics
  # ---------------------------------------------------------------------------
  computed_metrics:
    description: "Pre-aggregated portfolio metrics - USE FOR TOTALS AND COMPLEX RATIOS"
    row_count: 8
    granularity: "One row per quarter (8 quarters of data)"
    primary_key: as_of_date
    use_cases:
      - "Portfolio-level totals without breakdowns"
      - "Complex ratios with annualization (NCO rate, ROE)"
      - "Metrics with validated formulas"
      - "Dashboard summary statistics"

    columns:
      as_of_date:
        type: DATE
        description: "Reporting quarter-end date"
        note: "Primary key"

      # Portfolio Totals
      total_outstanding_balance:
        type: DECIMAL(18,2)
        description: "Total portfolio outstanding balance"
        formula: "SUM(adjusted_eop_balance) from accounts"

      total_accounts:
        type: INTEGER
        description: "Total number of accounts"

      num_active_accounts:
        type: INTEGER
        description: "Number of active accounts"

      unique_customers:
        type: INTEGER
        description: "Number of unique customers"

      # Delinquency Metrics
      num_accounts_30_plus_dpd:
        type: INTEGER
        description: "Number of accounts 30+ days past due"

      delinquency_rate_30_plus:
        type: DECIMAL(10,4)
        description: "30+ DPD delinquency rate (balance-weighted)"
        formula: "SUM(balance where DPD >= 30) / SUM(total balance) * 100"
        note: "PRE-COMPUTED with validated formula"

      delinquent_amount_30_plus:
        type: DECIMAL(18,2)
        description: "Total balance 30+ DPD"

      # Loss Metrics
      total_gross_charge_off:
        type: DECIMAL(18,2)
        description: "Total gross charge-offs"

      total_net_charge_off_ytd:
        type: DECIMAL(18,2)
        description: "Total net charge-offs YTD"

      net_charge_off_rate:
        type: DECIMAL(10,4)
        description: "Annualized net charge-off rate"
        formula: "(Net Charge-Offs YTD / Avg Balance) * (12 / months elapsed) * 100"
        note: "ALWAYS use this - annualization is complex and error-prone"

      # ECL Metrics
      total_expected_credit_loss:
        type: DECIMAL(18,2)
        description: "Total expected credit loss"

      ecl_coverage_ratio:
        type: DECIMAL(10,4)
        description: "ECL coverage ratio"
        formula: "Total ECL / NPL Balance * 100"
        note: "ALWAYS use this pre-computed value"

      # Product Breakdown
      num_accounts_mtg:
        type: INTEGER
        description: "Number of mortgage accounts"

      balance_mtg:
        type: DECIMAL(18,2)
        description: "Total mortgage balance"

      num_accounts_auto:
        type: INTEGER
        description: "Number of auto loan accounts"

      balance_auto:
        type: DECIMAL(18,2)
        description: "Total auto loan balance"

      num_accounts_cc:
        type: INTEGER
        description: "Number of credit card accounts"

      balance_cc:
        type: DECIMAL(18,2)
        description: "Total credit card balance"

      num_accounts_pl:
        type: INTEGER
        description: "Number of personal loan accounts"

      balance_pl:
        type: DECIMAL(18,2)
        description: "Total personal loan balance"

      num_accounts_heloc:
        type: INTEGER
        description: "Number of HELOC accounts"

      balance_heloc:
        type: DECIMAL(18,2)
        description: "Total HELOC balance"

# =============================================================================
# SECTION 4: METRIC DEFINITIONS (MERGED - KEY METRICS)
# =============================================================================

metrics:

  # ---------------------------------------------------------------------------
  # EXPOSURE METRICS
  # ---------------------------------------------------------------------------

  gross_credit_exposure:
    display_name: "Gross Credit Exposure"
    category: exposure.gross_exposure
    description: "Total credit exposure before risk mitigation"
    unit: "USD"

    definition_extended: |
      Gross Credit Exposure represents the total potential loss the bank faces
      from a borrower before considering any collateral, guarantees, or other
      risk mitigants. It includes both drawn amounts (outstanding balance) and
      undrawn commitments (available credit that could be drawn).

    # FROM ACCOUNTS TABLE (when breakdown needed)
    formula_accounts: "SUM(adjusted_eop_balance)"
    sql_accounts: |
      SELECT
        SUM(adjusted_eop_balance) as gross_credit_exposure
      FROM accounts
      WHERE as_of_date = %(as_of_date)s

    # FROM COMPUTED_METRICS TABLE (portfolio total)
    formula_computed: "total_outstanding_balance"
    sql_computed: |
      SELECT
        total_outstanding_balance as gross_credit_exposure
      FROM computed_metrics
      WHERE as_of_date = %(as_of_date)s

    routing_hint: |
      - Use accounts if query has GROUP BY (by product, region, segment)
      - Use computed_metrics if query asks for "total" or "overall" or "portfolio"

    synonyms: ["total exposure", "credit exposure", "outstanding", "balance"]

  adjusted_eop_balance:
    display_name: "Adjusted End-of-Period Balance"
    category: exposure.outstanding_balance
    description: "Outstanding balance at period end after adjustments"
    unit: "USD"

    formula: "EOP Balance + Accrued Interest + Deferred Fees - Unamortized Discount"
    note: "PRIMARY METRIC for exposure calculations"

    related_metrics:
      - metric: gross_credit_exposure
        relationship: "component_of"
      - metric: utilization_rate
        relationship: "numerator_for"

    synonyms: ["outstanding balance", "outstanding", "balance", "loan balance"]

  current_credit_limit:
    display_name: "Current Credit Limit"
    category: exposure.credit_limits
    description: "Maximum credit currently available to borrower"
    unit: "USD"

    definition_extended: |
      The Current Credit Limit represents the maximum amount the borrower
      is authorized to draw. For revolving products (credit cards, HELOCs),
      this is the credit line amount. For term loans, this equals the original
      loan amount.

    related_metrics:
      - metric: utilization_rate
        relationship: "denominator_for"
      - metric: available_credit
        relationship: "derived"
        formula: "Available = Limit - Outstanding"

    synonyms: ["credit limit", "credit line", "limit"]

  # ---------------------------------------------------------------------------
  # DELINQUENCY METRICS
  # ---------------------------------------------------------------------------

  delinquency_rate_30_plus:
    display_name: "30+ Day Delinquency Rate"
    category: delinquency.delinquency_rates
    description: "Percentage of portfolio balance that is 30+ days past due"
    unit: "percent"

    definition_extended: |
      The 30+ Day Delinquency Rate measures the proportion of the portfolio
      that is at least one payment cycle past due. This is a critical early
      warning indicator because it captures accounts beginning to show stress
      and is a leading indicator (precedes charge-offs by 3-6 months).

      Industry standard thresholds:
      - Prime portfolios: < 2%
      - Near-prime: 2-5%
      - Subprime: 5-15%

    # FROM ACCOUNTS TABLE (calculated on the fly)
    formula_accounts: |
      SUM(CASE WHEN days_past_due >= 30 THEN adjusted_eop_balance ELSE 0 END) /
      NULLIF(SUM(adjusted_eop_balance), 0) * 100

    sql_accounts: |
      SELECT
        SUM(CASE WHEN days_past_due >= 30 THEN adjusted_eop_balance ELSE 0 END) /
        NULLIF(SUM(adjusted_eop_balance), 0) * 100 as delinquency_rate_30_plus
      FROM accounts
      WHERE as_of_date = %(as_of_date)s

    # FROM COMPUTED_METRICS TABLE (pre-calculated)
    formula_computed: "delinquency_rate_30_plus"
    sql_computed: |
      SELECT
        delinquency_rate_30_plus
      FROM computed_metrics
      WHERE as_of_date = %(as_of_date)s

    routing_hint: |
      - Use computed_metrics for portfolio-level rate
      - Use accounts for breakdown by product/region/segment

    validation_note: |
      When using accounts table, the calculated rate should match the pre-computed
      rate in computed_metrics for the same as_of_date (validation check)

    business_thresholds:
      target: "< 2.5%"
      alert: "2.5% - 4.0%"
      critical: "> 4.0%"

    related_metrics:
      - metric: delinquency_rate_90
        relationship: "subset"
      - metric: net_charge_off_rate
        relationship: "leads"
        description: "Delinquency is a leading indicator of future charge-offs"

    synonyms: ["30 day delinquency", "DPD 30", "30+ DPD", "delinquency rate", "arrears rate"]

  delinquency_rate_90:
    display_name: "90+ Day Delinquency Rate"
    category: delinquency.delinquency_rates
    description: "Percentage of portfolio 90+ days past due (serious delinquency)"
    unit: "percent"

    definition_extended: |
      The 90+ Day Delinquency Rate measures serious delinquency, typically
      indicating borrowers who are unlikely to self-cure and will likely
      result in charge-off. Often used as the definition of "default" in PD models
      and triggers NPL (Non-Performing Loan) classification.

    formula: "SUM(Balance where DPD >= 90) / SUM(Total Outstanding) * 100"

    business_thresholds:
      target: "< 1.0%"
      alert: "1.0% - 2.0%"
      critical: "> 2.0%"

    synonyms: ["90 day delinquency", "90+ DPD", "serious delinquency", "severe delinquency"]

  # ---------------------------------------------------------------------------
  # LOSS METRICS
  # ---------------------------------------------------------------------------

  net_charge_off_rate:
    display_name: "Net Charge-Off Rate"
    category: loss.charge_offs
    description: "Annualized rate of loans written off as losses"
    unit: "percent"

    definition_extended: |
      The Net Charge-Off (NCO) Rate is the most critical loss metric, measuring
      actual credit losses realized during the period. It represents the
      percentage of the portfolio written off as uncollectible, net of any
      recoveries on previously charged-off accounts.

      Key characteristics:
      1. Direct P&L impact (reduces earnings)
      2. Reduces capital ratios
      3. Lagging indicator (reflects past credit decisions)
      4. Most comparable metric across institutions

    # FROM ACCOUNTS TABLE (RISKY - complex annualization)
    formula_accounts: |
      (SUM(net_charge_off_ytd) / NULLIF(AVG(adjusted_eop_balance), 0)) *
      (12 / EXTRACT(MONTH FROM as_of_date)) * 100
    warning: "Complex annualization formula - PREFER computed_metrics for accuracy"

    # FROM COMPUTED_METRICS TABLE (validated formula - RECOMMENDED)
    formula_computed: "net_charge_off_rate"
    sql_computed: |
      SELECT
        net_charge_off_rate
      FROM computed_metrics
      WHERE as_of_date = %(as_of_date)s

    routing_hint: |
      ALWAYS use computed_metrics for NCO rate - annualization is error-prone.
      Only use accounts if breakdown by product/region is explicitly requested.

    critical_note: |
      NCO rate calculation requires:
      1. Year-to-date charge-offs
      2. Average balance (not EOP balance)
      3. Annualization factor based on months elapsed
      LLMs frequently make errors in this calculation - use pre-computed value.

    business_thresholds:
      target: "< 0.8%"
      alert: "0.8% - 1.5%"
      critical: "> 1.5%"

    related_metrics:
      - metric: delinquency_rate_90
        relationship: "led_by"
        description: "90+ delinquency predicts NCO with 3-6 month lag"

    synonyms: ["charge-off rate", "NCO rate", "loss rate", "write-off rate"]

  # ---------------------------------------------------------------------------
  # ECL METRICS
  # ---------------------------------------------------------------------------

  ecl_coverage_ratio:
    display_name: "ECL Coverage Ratio"
    category: loss.expected_loss
    description: "Expected credit loss as percentage of non-performing loans"
    unit: "percent"

    # FROM ACCOUNTS TABLE (complex - requires NPL calculation)
    formula_accounts: |
      SUM(expected_credit_loss) /
      NULLIF(SUM(CASE WHEN days_past_due >= 90 OR impaired_flag = 'Y' THEN adjusted_eop_balance ELSE 0 END), 0) * 100
    warning: "Complex NPL definition - PREFER computed_metrics"

    # FROM COMPUTED_METRICS TABLE (validated formula - RECOMMENDED)
    formula_computed: "ecl_coverage_ratio"
    sql_computed: |
      SELECT
        ecl_coverage_ratio
      FROM computed_metrics
      WHERE as_of_date = %(as_of_date)s

    routing_hint: |
      ALWAYS use computed_metrics for ECL coverage ratio.
      Only calculate from accounts if breakdown by product is required.

    synonyms: ["ECL coverage", "coverage ratio", "ECL ratio"]

  expected_credit_loss:
    display_name: "Expected Credit Loss"
    category: loss.expected_loss
    description: "Forward-looking estimate of credit losses (IFRS 9 / CECL)"
    unit: "USD"

    definition_extended: |
      Expected Credit Loss (ECL) is the probability-weighted estimate of
      credit losses over the expected life of the financial instrument.
      It is the cornerstone of IFRS 9 and CECL accounting standards.

      IFRS 9 staging:
      - Stage 1: 12-month ECL (performing loans)
      - Stage 2: Lifetime ECL (significant credit deterioration)
      - Stage 3: Lifetime ECL (credit-impaired/NPL)

    formula: "PD × LGD × EAD"

    components:
      - "twelve_month_pd: 12-month probability of default"
      - "loss_given_default: Expected loss severity (1 - Recovery Rate)"
      - "exposure_at_default: Expected exposure when default occurs"

    synonyms: ["ECL", "CECL allowance", "credit loss provision", "allowance"]

  # ---------------------------------------------------------------------------
  # RISK SCORE METRICS
  # ---------------------------------------------------------------------------

  average_credit_score:
    display_name: "Average Credit Score"
    category: risk_scores.bureau_scores
    description: "Portfolio-weighted average current credit score"
    unit: "score"

    definition_extended: |
      The Average Credit Score represents the portfolio's overall credit
      quality as measured by external credit bureau scores (typically FICO).

      Balance-weighted is most common as it reflects economic exposure.
      Large loans have more impact on portfolio risk.

      Score interpretation (FICO scale):
      - 800+: Exceptional
      - 740-799: Very Good
      - 670-739: Good
      - 580-669: Fair
      - <580: Poor

    formula: "SUM(Credit Score * Balance) / SUM(Balance)"

    business_thresholds:
      target: "> 720"
      alert: "680 - 720"
      critical: "< 680"

    related_metrics:
      - metric: twelve_month_pd
        relationship: "correlated"
        description: "Lower score = higher PD (inverse relationship)"

    synonyms: ["credit score", "FICO score", "bureau score", "portfolio score"]

  twelve_month_pd:
    display_name: "12-Month Probability of Default"
    category: risk_scores.probability_of_default
    description: "Probability borrower will default within next 12 months"
    unit: "probability"

    definition_extended: |
      The 12-Month Probability of Default (PD) is a forward-looking risk metric
      representing the likelihood that a borrower will default within the next
      year. It is a cornerstone of modern credit risk management:

      Key uses:
      1. IFRS 9 Stage 1 ECL calculation
      2. Basel regulatory capital (PD component of IRB)
      3. Pricing decisions
      4. Credit limit management
      5. Portfolio monitoring

    formula: "Model-derived probability based on risk characteristics"

    related_metrics:
      - metric: expected_credit_loss
        relationship: "input_to"
        description: "ECL = PD × LGD × EAD"
      - metric: current_credit_score
        relationship: "derived_from"
        description: "PD is inverse function of score"

    synonyms: ["PD", "probability of default", "default probability"]

  # ---------------------------------------------------------------------------
  # COLLATERAL METRICS
  # ---------------------------------------------------------------------------

  current_ltv:
    display_name: "Current Loan-to-Value Ratio"
    category: collateral.ltv_metrics
    description: "Current loan balance divided by current property value"
    unit: "percent"

    definition_extended: |
      The Loan-to-Value (LTV) ratio measures the loan amount relative to the
      collateral value, indicating how well-secured the loan is. A lower LTV
      means more equity cushion protecting against loss.

      Risk implications:
      - High LTV (>80%): Less equity cushion, higher LGD
      - Underwater (>100%): Loan exceeds property value, very high loss risk
      - Low LTV (<60%): Well-secured, low loss severity

    formula: "Current Loan Balance / Current Property Value × 100"

    business_thresholds:
      target: "< 70%"
      alert: "70% - 80%"
      critical: "> 80%"

    related_metrics:
      - metric: loss_given_default
        relationship: "drives"
        description: "Higher LTV = higher LGD"

    synonyms: ["LTV", "loan to value", "CLTV", "collateral coverage"]

  # ---------------------------------------------------------------------------
  # BEHAVIORAL METRICS
  # ---------------------------------------------------------------------------

  utilization_rate:
    display_name: "Credit Utilization Rate"
    category: behavioral.utilization
    description: "Percentage of credit limit currently in use"
    unit: "percent"

    definition_extended: |
      Credit Utilization measures how much of available credit the borrower
      is using. It is one of the most important behavioral early warning
      indicators because:

      1. High utilization signals financial stress
      2. It's a leading indicator of future delinquency
      3. It affects credit scores (30% of FICO score)
      4. Rising utilization often precedes defaults

      Interpretation:
      - <30%: Healthy usage
      - 30-50%: Moderate usage
      - 50-80%: Elevated usage (watch list)
      - >80%: High stress indicator

    formula: "Outstanding Balance / Credit Limit × 100"

    business_thresholds:
      target: "< 40%"
      alert: "40% - 60%"
      critical: "> 60%"

    related_metrics:
      - metric: delinquency_rate_30
        relationship: "leads"
        description: "High utilization predicts future delinquency"
      - metric: current_credit_score
        relationship: "affects"
        description: "High utilization lowers credit scores"

    synonyms: ["utilization", "credit usage", "line usage", "usage rate"]

# =============================================================================
# SECTION 5: METRIC RELATIONSHIP MAPS (CONDENSED)
# =============================================================================

metric_relationships:

  exposure_chain:
    description: "How exposure metrics relate"
    flow: |
      Current Credit Limit → Available Credit
           ↓
      Outstanding Balance → Utilization Rate
           ↓
      Gross Credit Exposure

  loss_prediction_chain:
    description: "From early warning to realized loss"
    flow: |
      Credit Score → Probability of Default (PD)
           ↓
      Utilization → Delinquency 30+ → Delinquency 90+
                         ↓
                    ECL / NPL → Charge-Off (NCO)

  ecl_chain:
    description: "Components of Expected Credit Loss"
    flow: |
      Credit Score → PD
      LTV → LGD
      Balance → EAD
           ↓
      ECL = PD × LGD × EAD

# =============================================================================
# SECTION 6: CALCULATION RULES (CONDENSED)
# =============================================================================

calculation_rules:

  rate_calculations:
    balance_weighted:
      description: "Rate based on dollar amounts"
      formula: "SUM(Metric Amount) / SUM(Total Balance)"
      use_cases: ["Delinquency rate", "NCO rate", "NPL ratio"]

    count_weighted:
      description: "Rate based on number of accounts"
      formula: "COUNT(Metric Flag = Y) / COUNT(All Accounts)"
      use_cases: ["Account-level delinquency", "Default rate by count"]

  weighted_averages:
    by_balance:
      description: "Weight by outstanding balance"
      formula: "SUM(Metric × Balance) / SUM(Balance)"
      metrics: ["Average Credit Score", "Average LTV", "Average PD"]
      rationale: "Larger exposures have more portfolio impact"

  annualization:
    quarterly_to_annual:
      formula: "Quarterly Rate × 4"
      example: "Quarterly NCO 0.12% → Annual 0.48%"

    ytd_to_annual:
      formula: "YTD Rate × (12 / Months Elapsed)"
      example: "6-month NCO 0.24% → Annual 0.48%"

    note: "Use average balance for denominator when annualizing"

# =============================================================================
# SECTION 7: SQL GENERATION PATTERNS
# =============================================================================

sql_generation_guidance:

  pattern_1_portfolio_total:
    description: "Query for overall portfolio metric without breakdowns"
    recommended_table: computed_metrics
    example_query: "What is the total delinquency rate?"
    sql_template: |
      SELECT delinquency_rate_30_plus
      FROM computed_metrics
      WHERE as_of_date = (SELECT MAX(as_of_date) FROM computed_metrics)

    when_to_use:
      - "Query contains 'total', 'overall', 'portfolio', 'aggregate'"
      - "No GROUP BY dimensions mentioned"
      - "Metric is available in computed_metrics table"

  pattern_2_breakdown_by_dimension:
    description: "Query with GROUP BY (by product, region, segment, etc.)"
    recommended_table: accounts
    example_query: "What is the delinquency rate by product?"
    sql_template: |
      SELECT
        product_code,
        SUM(CASE WHEN days_past_due >= 30 THEN adjusted_eop_balance ELSE 0 END) /
        NULLIF(SUM(adjusted_eop_balance), 0) * 100 as delinquency_rate_30_plus
      FROM accounts
      WHERE as_of_date = %(as_of_date)s
      GROUP BY product_code
      ORDER BY delinquency_rate_30_plus DESC

    when_to_use:
      - "Query contains 'by product', 'by region', 'by segment', 'breakdown'"
      - "Requires GROUP BY clause"
      - "Need granular data aggregation"

  pattern_3_account_filter:
    description: "Query filtering by account-level attributes"
    recommended_table: accounts
    example_query: "Show me Auto loans with credit score below 650"
    sql_template: |
      SELECT
        account_id,
        customer_id,
        current_credit_score,
        adjusted_eop_balance,
        days_past_due
      FROM accounts
      WHERE product_code = 'AUTO'
        AND current_credit_score < 650
        AND as_of_date = %(as_of_date)s
      ORDER BY adjusted_eop_balance DESC
      LIMIT 100

    when_to_use:
      - "Query filters on account-level attributes (credit score, DPD, status)"
      - "Need row-level detail"
      - "Customer or account-specific queries"

  pattern_4_time_series:
    description: "Time series analysis across multiple quarters"
    recommended_table: accounts
    example_query: "Show delinquency rate trend over the last 4 quarters"
    sql_template: |
      SELECT
        as_of_date,
        SUM(CASE WHEN days_past_due >= 30 THEN adjusted_eop_balance ELSE 0 END) /
        NULLIF(SUM(adjusted_eop_balance), 0) * 100 as delinquency_rate_30_plus
      FROM accounts
      WHERE as_of_date >= %(start_date)s
      GROUP BY as_of_date
      ORDER BY as_of_date

    when_to_use:
      - "Query mentions 'trend', 'over time', 'historical'"
      - "Multiple time periods in single query"
      - "Time series analysis"

# =============================================================================
# SECTION 8: DIMENSIONS (DENORMALIZED)
# =============================================================================

dimensions:

  product:
    description: "Product type"
    column: product_code
    table: accounts
    values: [MTG, AUTO, CC, PL, HELOC]
    value_labels:
      MTG: "Mortgage"
      AUTO: "Auto Loan"
      CC: "Credit Card"
      PL: "Personal Loan"
      HELOC: "Home Equity Line of Credit"

  region:
    description: "Geographic region"
    column: region_code
    table: accounts
    values: [Northeast, Southeast, Midwest, West, Central]

  segment:
    description: "Customer credit risk segment"
    column: customer_segment
    table: accounts
    values: [PRIME, NEAR_PRIME, SUBPRIME]

  channel:
    description: "Application/origination channel"
    column: application_channel
    table: accounts
    values: [BRANCH, ONLINE, MOBILE, BROKER, DEALER, DIRECT_MAIL]

  status:
    description: "Account status"
    column: account_status
    table: accounts
    values: [ACTIVE, CLOSED, PAID_OFF, CHARGED_OFF]

# =============================================================================
# SECTION 9: BUSINESS CONTEXT & THRESHOLDS
# =============================================================================

business_context:

  risk_thresholds:
    delinquency_30:
      target: "< 2.5%"
      alert: "2.5% - 4.0%"
      critical: "> 4.0%"

    delinquency_90:
      target: "< 1.0%"
      alert: "1.0% - 2.0%"
      critical: "> 2.0%"

    nco_rate_annual:
      target: "< 0.8%"
      alert: "0.8% - 1.5%"
      critical: "> 1.5%"

    avg_credit_score:
      target: "> 720"
      alert: "680 - 720"
      critical: "< 680"

    avg_ltv:
      target: "< 70%"
      alert: "70% - 80%"
      critical: "> 80%"

    utilization:
      target: "< 40%"
      alert: "40% - 60%"
      critical: "> 60%"

# =============================================================================
# SECTION 10: DATA AVAILABILITY
# =============================================================================

database_metadata:
  data_availability:
    date_range:
      available_quarters: ["Q1 2024", "Q2 2024", "Q3 2024", "Q4 2024", "Q1 2025", "Q2 2025", "Q3 2025", "Q4 2025"]
      note: "8 quarters of quarterly snapshots"

    products:
      available: [MTG, AUTO, CC, PL, HELOC]

    regions:
      available: [Northeast, Southeast, Midwest, West, Central]

    segments:
      available: [PRIME, NEAR_PRIME, SUBPRIME]

# =============================================================================
# SECTION 11: VALIDATION RULES
# =============================================================================

validation:

  cross_table_reconciliation:
    description: "Validate that aggregations from accounts match computed_metrics"

    test_1_total_balance:
      check: "SUM(adjusted_eop_balance) from accounts should equal total_outstanding_balance from computed_metrics"
      sql_accounts: "SELECT SUM(adjusted_eop_balance) FROM accounts WHERE as_of_date = %(date)s"
      sql_computed: "SELECT total_outstanding_balance FROM computed_metrics WHERE as_of_date = %(date)s"
      tolerance: 0.01  # Allow $0.01 difference due to rounding

    test_2_delinquency_rate:
      check: "Delinquency rate calculated from accounts should match pre-computed rate"
      tolerance_percent: 0.001  # 0.001% tolerance

  llm_calculation_confidence:
    simple_aggregations:
      confidence: "HIGH"
      examples: ["SUM(balance)", "COUNT(*)", "AVG(score)"]
      action: "Allow LLM to calculate from accounts table"

    ratios_without_annualization:
      confidence: "MEDIUM"
      examples: ["Delinquency rate", "Utilization rate", "LTV ratio"]
      action: "Validate against computed_metrics when available"

    complex_ratios_with_annualization:
      confidence: "ZERO"
      examples: ["NCO rate", "ROE", "ROA"]
      action: "FORCE use of computed_metrics table - never calculate from accounts"

# =============================================================================
# SECTION 12: GLOSSARY
# =============================================================================

glossary:
  AOB: "Adjusted Outstanding Balance"
  CCF: "Credit Conversion Factor"
  CCL: "Current Credit Limit"
  CECL: "Current Expected Credit Loss (US GAAP)"
  CLTV: "Combined Loan-to-Value"
  DPD: "Days Past Due"
  EAD: "Exposure at Default"
  ECL: "Expected Credit Loss"
  EOP: "End of Period"
  GCE: "Gross Credit Exposure"
  IFRS9: "International Financial Reporting Standard 9"
  LGD: "Loss Given Default"
  LTV: "Loan-to-Value"
  MTD: "Month-to-Date"
  NCO: "Net Charge-Off"
  NPL: "Non-Performing Loan (typically 90+ DPD)"
  PD: "Probability of Default"
  QTD: "Quarter-to-Date"
  YTD: "Year-to-Date"

# =============================================================================
# END OF SEMANTIC MODEL - PRODUCTION VERSION 4.0
# =============================================================================
